"use strict";const a=require("obsidian"),S={registrationId:"",noteLocation:"Locations/Institutes",institutionNoteTemplate:"",autoGenerateInstitutionNotes:!1,openInstitutionAfterCreation:!1,listenToFileCreatedInPath:"Persons/Scholars"};class R extends a.PluginSettingTab{constructor(e,t){super(e,t),this.debounceSave=a.debounce(()=>{this.plugin.saveSettings()},1e3),this.plugin=t}display(){const{containerEl:e}=this;e.empty();const t=new DocumentFragment;t.createEl("span",{cls:"paperbell-code-desc",text:"Enter your Paperbell registration ID. You can get one from "},r=>{r.createEl("a",{href:"https://paperbell.com/",text:"https://paperbell.com/"})}),new a.Setting(e).setName("🎓 Registration ID").setDesc(t).addText(r=>{r.inputEl.type="password",r.setPlaceholder("Enter registration ID").setValue(this.plugin.settings.registrationId).onChange(async i=>{this.plugin.settings.registrationId=i,this.debounceSave()})}),new a.Setting(e).setName("New institution note location").setDesc("Where to create new institution notes").addText(r=>{r.setPlaceholder("Enter location").setValue(this.plugin.settings.noteLocation).onChange(async i=>{this.plugin.settings.noteLocation=i,this.debounceSave()})}),new a.Setting(e).setName("Institution note template").setDesc("Template for institution notes").addText(r=>{new P(this.app,r.inputEl,i=>{this.plugin.settings.institutionNoteTemplate=i,this.debounceSave()}),r.setPlaceholder("Enter template").setValue(this.plugin.settings.institutionNoteTemplate).onChange(async i=>{this.plugin.settings.institutionNoteTemplate=i,this.debounceSave()})}),new a.Setting(e).setName("Auto-generate institution notes").setDesc("Automatically generate institution notes when importing").addToggle(r=>{r.setValue(this.plugin.settings.autoGenerateInstitutionNotes).onChange(async i=>{this.plugin.settings.autoGenerateInstitutionNotes=i,this.debounceSave()})}),new a.Setting(e).setName("Open institution after creation").setDesc("Open the institution note after it is created").addToggle(r=>{r.setValue(this.plugin.settings.openInstitutionAfterCreation).onChange(async i=>{this.plugin.settings.openInstitutionAfterCreation=i,this.debounceSave()})}),new a.Setting(e).setName("Listen to file created in path").setDesc("Where to listen for new files to create institution notes for").addText(r=>{r.setPlaceholder("Enter location").setValue(this.plugin.settings.listenToFileCreatedInPath).onChange(async i=>{this.plugin.settings.listenToFileCreatedInPath=i,this.debounceSave()})})}}class P extends a.AbstractInputSuggest{constructor(e,t,r){super(e,t),this.inputEl=t,this.onChange=r}getSuggestions(e){const t=this.app.vault.getMarkdownFiles();if(!e)return t;const r=a.prepareFuzzySearch(e.toLowerCase());return t.map(n=>{const o=n.path.slice(0,-3).toLowerCase(),c=r(o);return{file:n,result:c}}).filter(n=>n.result!==null).sort((n,o)=>o.result.score-n.result.score).map(n=>n.file)}renderSuggestion(e,t){t.setText(e.basename)}selectSuggestion(e,t){const r=e.path.slice(0,-3);this.setValue(r),this.onChange(r),this.close()}}const k='(function(){"use strict";var w=crypto;const K=e=>e instanceof CryptoKey,g=new TextEncoder,_=new TextDecoder;function M(...e){const r=e.reduce((n,{length:s})=>n+s,0),t=new Uint8Array(r);let o=0;for(const n of e)t.set(n,o),o+=n.length;return t}const V=e=>{const r=atob(e),t=new Uint8Array(r.length);for(let o=0;o<r.length;o++)t[o]=r.charCodeAt(o);return t},h=e=>{let r=e;r instanceof Uint8Array&&(r=_.decode(r)),r=r.replace(/-/g,"+").replace(/_/g,"/").replace(/\\s/g,"");try{return V(r)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class u extends Error{constructor(r,t){var o;super(r,t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,(o=Error.captureStackTrace)==null||o.call(Error,this,this.constructor)}}u.code="ERR_JOSE_GENERIC";class B extends u{constructor(r,t,o="unspecified",n="unspecified"){super(r,{cause:{claim:o,reason:n,payload:t}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=o,this.reason=n,this.payload=t}}B.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class G extends u{constructor(r,t,o="unspecified",n="unspecified"){super(r,{cause:{claim:o,reason:n,payload:t}}),this.code="ERR_JWT_EXPIRED",this.claim=o,this.reason=n,this.payload=t}}G.code="ERR_JWT_EXPIRED";class F extends u{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}}F.code="ERR_JOSE_ALG_NOT_ALLOWED";class d extends u{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}}d.code="ERR_JOSE_NOT_SUPPORTED";class Y extends u{constructor(r="decryption operation failed",t){super(r,t),this.code="ERR_JWE_DECRYPTION_FAILED"}}Y.code="ERR_JWE_DECRYPTION_FAILED";class q extends u{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}}q.code="ERR_JWE_INVALID";class i extends u{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}}i.code="ERR_JWS_INVALID";class Q extends u{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}}Q.code="ERR_JWT_INVALID";class X extends u{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}}X.code="ERR_JWK_INVALID";class z extends u{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}}z.code="ERR_JWKS_INVALID";class Z extends u{constructor(r="no applicable key found in the JSON Web Key Set",t){super(r,t),this.code="ERR_JWKS_NO_MATCHING_KEY"}}Z.code="ERR_JWKS_NO_MATCHING_KEY";class ee extends u{constructor(r="multiple matching keys found in the JSON Web Key Set",t){super(r,t),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}ee.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class re extends u{constructor(r="request timed out",t){super(r,t),this.code="ERR_JWKS_TIMEOUT"}}re.code="ERR_JWKS_TIMEOUT";class C extends u{constructor(r="signature verification failed",t){super(r,t),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}C.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";function f(e,r="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${r} must be ${e}`)}function A(e,r){return e.name===r}function k(e){return parseInt(e.name.slice(4),10)}function te(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function oe(e,r){if(r.length&&!r.some(t=>e.usages.includes(t))){let t="CryptoKey does not support this operation, its usages must include ";if(r.length>2){const o=r.pop();t+=`one of ${r.join(", ")}, or ${o}.`}else r.length===2?t+=`one of ${r[0]} or ${r[1]}.`:t+=`${r[0]}.`;throw new TypeError(t)}}function ne(e,r,...t){switch(r){case"HS256":case"HS384":case"HS512":{if(!A(e.algorithm,"HMAC"))throw f("HMAC");const o=parseInt(r.slice(2),10);if(k(e.algorithm.hash)!==o)throw f(`SHA-${o}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!A(e.algorithm,"RSASSA-PKCS1-v1_5"))throw f("RSASSA-PKCS1-v1_5");const o=parseInt(r.slice(2),10);if(k(e.algorithm.hash)!==o)throw f(`SHA-${o}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!A(e.algorithm,"RSA-PSS"))throw f("RSA-PSS");const o=parseInt(r.slice(2),10);if(k(e.algorithm.hash)!==o)throw f(`SHA-${o}`,"algorithm.hash");break}case"EdDSA":if(e.algorithm.name!=="Ed25519"&&e.algorithm.name!=="Ed448")throw f("Ed25519 or Ed448");break;case"ES256":case"ES384":case"ES512":{if(!A(e.algorithm,"ECDSA"))throw f("ECDSA");const o=te(r);if(e.algorithm.namedCurve!==o)throw f(o,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}oe(e,t)}function T(e,r,...t){var o;if(t=t.filter(Boolean),t.length>2){const n=t.pop();e+=`one of type ${t.join(", ")}, or ${n}.`}else t.length===2?e+=`one of type ${t[0]} or ${t[1]}.`:e+=`of type ${t[0]}.`;return r==null?e+=` Received ${r}`:typeof r=="function"&&r.name?e+=` Received function ${r.name}`:typeof r=="object"&&r!=null&&(o=r.constructor)!=null&&o.name&&(e+=` Received an instance of ${r.constructor.name}`),e}var J=(e,...r)=>T("Key must be ",e,...r);function O(e,r,...t){return T(`Key for the ${e} algorithm must be `,r,...t)}var D=e=>K(e)?!0:(e==null?void 0:e[Symbol.toStringTag])==="KeyObject";const v=["CryptoKey"],se=(...e)=>{const r=e.filter(Boolean);if(r.length===0||r.length===1)return!0;let t;for(const o of r){const n=Object.keys(o);if(!t||t.size===0){t=new Set(n);continue}for(const s of n){if(t.has(s))return!1;t.add(s)}}return!0};function ae(e){return typeof e=="object"&&e!==null}function R(e){if(!ae(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let r=e;for(;Object.getPrototypeOf(r)!==null;)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}var ie=(e,r)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:t}=r.algorithm;if(typeof t!="number"||t<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function y(e){return R(e)&&typeof e.kty=="string"}function ce(e){return e.kty!=="oct"&&typeof e.d=="string"}function ue(e){return e.kty!=="oct"&&typeof e.d>"u"}function de(e){return y(e)&&e.kty==="oct"&&typeof e.k=="string"}function le(e){let r,t;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":r={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},t=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":r={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},t=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":r={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},t=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new d(\'Invalid or unsupported JWK "alg" (Algorithm) Parameter value\')}break;case"EC":switch(e.alg){case"ES256":r={name:"ECDSA",namedCurve:"P-256"},t=e.d?["sign"]:["verify"];break;case"ES384":r={name:"ECDSA",namedCurve:"P-384"},t=e.d?["sign"]:["verify"];break;case"ES512":r={name:"ECDSA",namedCurve:"P-521"},t=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":r={name:"ECDH",namedCurve:e.crv},t=e.d?["deriveBits"]:[];break;default:throw new d(\'Invalid or unsupported JWK "alg" (Algorithm) Parameter value\')}break;case"OKP":switch(e.alg){case"EdDSA":r={name:e.crv},t=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":r={name:e.crv},t=e.d?["deriveBits"]:[];break;default:throw new d(\'Invalid or unsupported JWK "alg" (Algorithm) Parameter value\')}break;default:throw new d(\'Invalid or unsupported JWK "kty" (Key Type) Parameter value\')}return{algorithm:r,keyUsages:t}}const H=async e=>{if(!e.alg)throw new TypeError(\'"alg" argument is required when "jwk.alg" is not present\');const{algorithm:r,keyUsages:t}=le(e),o=[r,e.ext??!1,e.key_ops??t],n={...e};return delete n.alg,delete n.use,w.subtle.importKey("jwk",n,...o)},N=e=>h(e);let S,E;const $=e=>(e==null?void 0:e[Symbol.toStringTag])==="KeyObject",b=async(e,r,t,o,n=!1)=>{let s=e.get(r);if(s!=null&&s[o])return s[o];const a=await H({...t,alg:o});return n&&Object.freeze(r),s?s[o]=a:e.set(r,{[o]:a}),a};var fe={normalizePublicKey:(e,r)=>{if($(e)){let t=e.export({format:"jwk"});return delete t.d,delete t.dp,delete t.dq,delete t.p,delete t.q,delete t.qi,t.k?N(t.k):(E||(E=new WeakMap),b(E,e,t,r))}return y(e)?e.k?h(e.k):(E||(E=new WeakMap),b(E,e,e,r,!0)):e},normalizePrivateKey:(e,r)=>{if($(e)){let t=e.export({format:"jwk"});return t.k?N(t.k):(S||(S=new WeakMap),b(S,e,t,r))}return y(e)?e.k?h(e.k):(S||(S=new WeakMap),b(S,e,e,r,!0)):e}};const p=(e,r,t=0)=>{t===0&&(r.unshift(r.length),r.unshift(6));const o=e.indexOf(r[0],t);if(o===-1)return!1;const n=e.subarray(o,o+r.length);return n.length!==r.length?!1:n.every((s,a)=>s===r[a])||p(e,r,o+1)},L=e=>{switch(!0){case p(e,[42,134,72,206,61,3,1,7]):return"P-256";case p(e,[43,129,4,0,34]):return"P-384";case p(e,[43,129,4,0,35]):return"P-521";case p(e,[43,101,110]):return"X25519";case p(e,[43,101,111]):return"X448";case p(e,[43,101,112]):return"Ed25519";case p(e,[43,101,113]):return"Ed448";default:throw new d("Invalid or unsupported EC Key Curve or OKP Key Sub Type")}},pe=async(e,r,t,o,n)=>{let s,a;const c=new Uint8Array(atob(t.replace(e,"")).split("").map(l=>l.charCodeAt(0)));switch(o){case"PS256":case"PS384":case"PS512":s={name:"RSA-PSS",hash:`SHA-${o.slice(-3)}`},a=["verify"];break;case"RS256":case"RS384":case"RS512":s={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${o.slice(-3)}`},a=["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":s={name:"RSA-OAEP",hash:`SHA-${parseInt(o.slice(-3),10)||1}`},a=["encrypt","wrapKey"];break;case"ES256":s={name:"ECDSA",namedCurve:"P-256"},a=["verify"];break;case"ES384":s={name:"ECDSA",namedCurve:"P-384"},a=["verify"];break;case"ES512":s={name:"ECDSA",namedCurve:"P-521"},a=["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{const l=L(c);s=l.startsWith("P-")?{name:"ECDH",namedCurve:l}:{name:l},a=[];break}case"EdDSA":s={name:L(c)},a=["verify"];break;default:throw new d(\'Invalid or unsupported "alg" (Algorithm) value\')}return w.subtle.importKey(r,c,s,!1,a)},he=(e,r,t)=>pe(/(?:-----(?:BEGIN|END) PUBLIC KEY-----|\\s)/g,"spki",e,r);async function ye(e,r,t){if(e.indexOf("-----BEGIN PUBLIC KEY-----")!==0)throw new TypeError(\'"spki" must be SPKI formatted string\');return he(e,r)}async function Se(e,r){if(!R(e))throw new TypeError("JWK must be an object");switch(r||(r=e.alg),e.kty){case"oct":if(typeof e.k!="string"||!e.k)throw new TypeError(\'missing "k" (Key Value) Parameter value\');return h(e.k);case"RSA":if(e.oth!==void 0)throw new d(\'RSA JWK "oth" (Other Primes Info) Parameter value is not supported\');case"EC":case"OKP":return H({...e,alg:r});default:throw new d(\'Unsupported "kty" (Key Type) Parameter value\')}}const m=e=>e==null?void 0:e[Symbol.toStringTag],W=(e,r,t)=>{var o,n;if(r.use!==void 0&&r.use!=="sig")throw new TypeError("Invalid key for this operation, when present its use must be sig");if(r.key_ops!==void 0&&((n=(o=r.key_ops).includes)==null?void 0:n.call(o,t))!==!0)throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${t}`);if(r.alg!==void 0&&r.alg!==e)throw new TypeError(`Invalid key for this operation, when present its alg must be ${e}`);return!0},Ee=(e,r,t,o)=>{if(!(r instanceof Uint8Array)){if(o&&y(r)){if(de(r)&&W(e,r,t))return;throw new TypeError(\'JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present\')}if(!D(r))throw new TypeError(O(e,r,...v,"Uint8Array",o?"JSON Web Key":null));if(r.type!=="secret")throw new TypeError(`${m(r)} instances for symmetric algorithms must be of type "secret"`)}},me=(e,r,t,o)=>{if(o&&y(r))switch(t){case"sign":if(ce(r)&&W(e,r,t))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"verify":if(ue(r)&&W(e,r,t))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!D(r))throw new TypeError(O(e,r,...v,o?"JSON Web Key":null));if(r.type==="secret")throw new TypeError(`${m(r)} instances for asymmetric algorithms must not be of type "secret"`);if(t==="sign"&&r.type==="public")throw new TypeError(`${m(r)} instances for asymmetric algorithm signing must be of type "private"`);if(t==="decrypt"&&r.type==="public")throw new TypeError(`${m(r)} instances for asymmetric algorithm decryption must be of type "private"`);if(r.algorithm&&t==="verify"&&r.type==="private")throw new TypeError(`${m(r)} instances for asymmetric algorithm verifying must be of type "public"`);if(r.algorithm&&t==="encrypt"&&r.type==="private")throw new TypeError(`${m(r)} instances for asymmetric algorithm encryption must be of type "public"`)};function U(e,r,t,o){r.startsWith("HS")||r==="dir"||r.startsWith("PBES2")||/^A\\d{3}(?:GCM)?KW$/.test(r)?Ee(r,t,o,e):me(r,t,o,e)}U.bind(void 0,!1);const j=U.bind(void 0,!0);function we(e,r,t,o,n){if(n.crit!==void 0&&(o==null?void 0:o.crit)===void 0)throw new e(\'"crit" (Critical) Header Parameter MUST be integrity protected\');if(!o||o.crit===void 0)return new Set;if(!Array.isArray(o.crit)||o.crit.length===0||o.crit.some(a=>typeof a!="string"||a.length===0))throw new e(\'"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present\');let s;s=r;for(const a of o.crit){if(!s.has(a))throw new d(`Extension Header Parameter "${a}" is not recognized`);if(n[a]===void 0)throw new e(`Extension Header Parameter "${a}" is missing`);if(s.get(a)&&o[a]===void 0)throw new e(`Extension Header Parameter "${a}" MUST be integrity protected`)}return new Set(o.crit)}function ge(e,r){const t=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:t,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:t,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:t,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:t,name:"ECDSA",namedCurve:r.namedCurve};case"EdDSA":return{name:r.name};default:throw new d(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}async function Ae(e,r,t){if(r=await fe.normalizePublicKey(r,e),K(r))return ne(r,e,t),r;if(r instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(J(r,...v));return w.subtle.importKey("raw",r,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[t])}throw new TypeError(J(r,...v,"Uint8Array","JSON Web Key"))}const ve=async(e,r,t,o)=>{const n=await Ae(e,r,"verify");ie(e,n);const s=ge(e,n.algorithm);try{return await w.subtle.verify(s,n,t,o)}catch{return!1}};async function Re(e,r,t){if(!R(e))throw new i("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new i(\'Flattened JWS must have either of the "protected" or "header" members\');if(e.protected!==void 0&&typeof e.protected!="string")throw new i("JWS Protected Header incorrect type");if(e.payload===void 0)throw new i("JWS Payload missing");if(typeof e.signature!="string")throw new i("JWS Signature missing or incorrect type");if(e.header!==void 0&&!R(e.header))throw new i("JWS Unprotected Header incorrect type");let o={};if(e.protected)try{const _e=h(e.protected);o=JSON.parse(_.decode(_e))}catch{throw new i("JWS Protected Header is invalid")}if(!se(o,e.header))throw new i("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const n={...o,...e.header},s=we(i,new Map([["b64",!0]]),t==null?void 0:t.crit,o,n);let a=!0;if(s.has("b64")&&(a=o.b64,typeof a!="boolean"))throw new i(\'The "b64" (base64url-encode payload) Header Parameter must be a boolean\');const{alg:c}=n;if(typeof c!="string"||!c)throw new i(\'JWS "alg" (Algorithm) Header Parameter missing or invalid\');if(a){if(typeof e.payload!="string")throw new i("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new i("JWS Payload must be a string or an Uint8Array instance");let l=!1;typeof r=="function"?(r=await r(o,e),l=!0,j(c,r,"verify"),y(r)&&(r=await Se(r,c))):j(c,r,"verify");const Ie=M(g.encode(e.protected??""),g.encode("."),typeof e.payload=="string"?g.encode(e.payload):e.payload);let x;try{x=h(e.signature)}catch{throw new i("Failed to base64url decode the signature")}if(!await ve(c,r,x,Ie))throw new C;let P;if(a)try{P=h(e.payload)}catch{throw new i("Failed to base64url decode the payload")}else typeof e.payload=="string"?P=g.encode(e.payload):P=e.payload;const I={payload:P};return e.protected!==void 0&&(I.protectedHeader=o),e.header!==void 0&&(I.unprotectedHeader=e.header),l?{...I,key:r}:I}async function be(e,r,t){if(e instanceof Uint8Array&&(e=_.decode(e)),typeof e!="string")throw new i("Compact JWS must be a string or Uint8Array");const{0:o,1:n,2:s,length:a}=e.split(".");if(a!==3)throw new i("Invalid Compact JWS");const c=await Re({payload:n,protected:o,signature:s},r,t),l={payload:c.payload,protectedHeader:c.protectedHeader};return typeof r=="function"?{...l,key:c.key}:l}const Pe=`-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtpd61EQD2G80pjc1kBe8/UtcVN0pZxfYrAOHGqu4l+eFZDlwujX/ogeqJI/MIO1AIbxkWM4RfJ5Z5khrI7lKnnINmk1iJ06ahFDpc8zFsRSkjO+sflOrL4BKuL1gWoFSAsUWjAj8Q5lQY9BRqHHoj8bYC2pPowWfj4cPv2vQVBiK2LCzgU7lE3cECL16ZcPRu7ZfYQc2+oW5pxVIE7UK9Vjlhjn+nV89Bv400dZ5HM92WNUhUE3jxxw8YG62gs6Sa6RCNbJ5/qqarXcnvUfpSb10TlylXHPDkSqAkDRC2hNZQ6GXxtnsRii5+eXkb19kQXv55j9LYaJlWyzmUcLw1wIDAQAB\n-----END PUBLIC KEY-----`;self.addEventListener("message",e=>{Promise.resolve().then(async()=>{var r;try{const t=e.data;let o=!1;const n=t;if(n.type==="verify"){if(!n.verificationId){postMessage({messageSource:"verify",$error:"Access denied: No registration ID provided"});return}try{if(!n.verified){const s=await ye(Pe,"RS256"),{payload:a}=await be(n.verificationId,s),c=JSON.parse(new TextDecoder().decode(a));if(Date.now()>c.expiresAt){postMessage({messageSource:"mindmap",$error:"Access denied: Verification token has expired"});return}}o=!0,postMessage({messageSource:"verify",type:"success",verified:o})}catch(s){console.error("Verification error:",s),postMessage({messageSource:"verify",$error:"Access denied: Invalid verification token"})}return}postMessage({messageSource:"verify",$error:"Unsupported import method."})}catch(t){console.error(`Worker failed to process ${(r=e.data)==null?void 0:r.path}: ${t}`),postMessage({messageSource:"verify",$error:t.message||"Unknown error in worker"})}})})})();\n',E=typeof self<"u"&&self.Blob&&new Blob([k],{type:"text/javascript;charset=utf-8"});function C(s){let e;try{if(e=E&&(self.URL||self.webkitURL).createObjectURL(E),!e)throw"";const t=new Worker(e,{name:s==null?void 0:s.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(k),{name:s==null?void 0:s.name})}finally{e&&(self.URL||self.webkitURL).revokeObjectURL(e)}}function _(){let s,e;const r=new Promise((i,n)=>{s=i,e=n});return r.resolve=s,r.reject=e,r}var m={},w={},b;function N(){if(b)return w;b=1;class s{constructor(t){this._elements=Array.isArray(t)?t:[],this._offset=0}enqueue(t){return this._elements.push(t),this}push(t){return this.enqueue(t)}dequeue(){if(this.size()===0)return null;const t=this.front();return this._offset+=1,this._offset*2<this._elements.length||(this._elements=this._elements.slice(this._offset),this._offset=0),t}pop(){return this.dequeue()}front(){return this.size()>0?this._elements[this._offset]:null}back(){return this.size()>0?this._elements[this._elements.length-1]:null}size(){return this._elements.length-this._offset}isEmpty(){return this.size()===0}toArray(){return this._elements.slice(this._offset)}clear(){this._elements=[],this._offset=0}clone(){return new s(this._elements.slice(this._offset))}static fromArray(t){return new s(t)}}return w.Queue=s,w}var A;function T(){if(A)return m;A=1;const{Queue:s}=N();return m.Queue=s,m}var W=T();const O={workers:4,utilization:.75};class D extends a.Component{constructor(e,t,r){super(),this.workers=new Map,this.shutdown=!1,this.nextWorkerId=0,this.throttle=r??(()=>O),this.queue=new W.Queue,this.outstanding=new Map,this.app=e,this.verificationId=t,this.verified=!1}unthrottle(){for(let e of this.workers.values())e.availableAt=Date.now()}async schedule(){if(this.queue.size()==0||this.shutdown)return;const e=this.availableWorker();if(!e)return;const[t]=this.queue.dequeue();e.active=[t,Date.now()];try{e.worker.postMessage({type:"verify",verificationId:this.verificationId,verified:this.verified})}catch{e.active=void 0}}finish(e,t){if(!e.active){this.verified=!1;return}if(!t){this.verified=!1,new a.Notice("Parser failed to verify, please check your verification id.");return}const[r,i]=e.active;if("$error"in t?r.reject(t.$error):r.resolve(t),this.workers.size>this.throttle().workers)this.workers.delete(e.id),I(e);else{const n=Date.now(),o=Math.max(.1,this.throttle().utilization)-1,c=(n-i)*o;e.active=void 0,c<=1e-10?(e.availableAt=n,this.schedule()):(e.availableAt=n+c,setTimeout(this.schedule.bind(this),c))}}availableWorker(){const e=Date.now();for(let t of this.workers.values())if(!t.active&&t.availableAt<=e)return t;if(this.workers.size<this.throttle().workers){let t=this.newWorker();return this.workers.set(t.id,t),t}}newWorker(){let e={id:this.nextWorkerId++,availableAt:Date.now(),worker:new C};return e.worker.onmessage=async t=>await this.handleWorkerMessage(e,t.data),e}onunload(){for(let e of this.workers.values())I(e);for(;!this.queue.isEmpty();){const[e]=this.queue.pop();e.reject("Terminated")}this.shutdown=!0}async verify(){try{const e=this.availableWorker();if(!e)throw new Error("No available workers in pool");let t=_();return e.active=[t,Date.now()],e.worker.postMessage({type:"verify",verificationId:this.verificationId,verified:this.verified}),(await t).verified}catch(e){return console.error("Parser failed to verify access. "+e),!1}}async handleWorkerMessage(e,t){if(t.messageSource==="verify"){if(t.$error){this.verified=!1,this.finish(e,t);return}e.active&&(this.verified=t.verified,this.finish(e,t));return}}}function I(s){s.worker.terminate(),s.active&&s.active[0].reject("Terminated"),s.active=void 0}class v extends a.Modal{constructor(e,t,r){super(e),this.plugin=t,this.institutionName=r}async onOpen(){this.titleEl.setText("Institution Verification"),this.contentEl.createEl("p",{text:"Please enter the institution name to search."});const e=this.contentEl.createDiv("search-container");this.inputEl=e.createEl("input",{type:"text",placeholder:"Institution name",cls:"institution-search-input"}),this.inputEl.addEventListener("keydown",async t=>{if(t.key==="Enter"){if(!await this.plugin.verificationWorker.verify()){new a.Notice("You are not authorized to use this feature. Please check your registration ID.");return}await this.searchInstitution(this.inputEl.value)}}),new a.Setting(e).addButton(t=>t.setButtonText("Search").onClick(async()=>{if(!await this.plugin.verificationWorker.verify()){new a.Notice("You are not authorized to use this feature. Please check your registration ID.");return}await this.searchInstitution(this.inputEl.value)})),this.resultContainer=this.contentEl.createDiv("search-results"),this.confirmButton=new a.Setting(this.contentEl).addButton(t=>t.setButtonText("Create Institution Note").setDisabled(!0).onClick(async()=>{var r,i,n,o,c,l,u,p,d,f,y;await this.plugin.createInstitutionNote({abbr:((r=this.institution.acronyms)==null?void 0:r[0])||"",aliases:[...this.institution.aliases||[],...((i=this.institution.labels)==null?void 0:i.map(h=>h.label))||[]],website:((n=this.institution.links)==null?void 0:n[0])||"",location:[((c=(o=this.institution.addresses)==null?void 0:o[0])==null?void 0:c.lat)||0,((u=(l=this.institution.addresses)==null?void 0:l[0])==null?void 0:u.lng)||0],logo:((d=(p=this.institution.logos)==null?void 0:p[0])==null?void 0:d.url)||"",name:((y=(f=this.institution.labels)==null?void 0:f[0])==null?void 0:y.label)||this.institution.name||"",tags:["university"]}),this.close()})),this.confirmButton.settingEl.hide(),this.institutionName&&(this.inputEl.value=this.institutionName,await this.plugin.verificationWorker.verify()&&this.searchInstitution(this.institutionName))}async searchInstitution(e){var t,r;try{const i=encodeURIComponent(`"${e}"`),o=await(await a.requestUrl({url:`https://api.ror.org/v1/organizations?query=${i}`,method:"GET"})).json;if(o.items&&o.items.length>0){this.institution=o.items[0];const c=((r=(t=this.institution.labels)==null?void 0:t[0])==null?void 0:r.label)||this.institution.name;c&&(this.institutionName=c),await this.displayResults()}}catch(i){console.error("Error searching institution:",i)}}async displayResults(){var t,r,i,n,o,c,l,u,p,d,f,y,h,g;this.resultContainer.empty();const e=`| Field | Value |
|--------|--------|
| Name | ${((r=(t=this.institution.labels)==null?void 0:t[0])==null?void 0:r.label)||this.institution.name||"N/A"} |
| Abbreviation | ${((i=this.institution.acronyms)==null?void 0:i[0])||"N/A"} |
| Website | ${((n=this.institution.links)==null?void 0:n[0])||"N/A"} |
| Location | ${((c=(o=this.institution.addresses)==null?void 0:o[0])==null?void 0:c.city)||"N/A"}, ${((l=this.institution.country)==null?void 0:l.country_name)||"N/A"} |
| Established | ${this.institution.established||"N/A"} |
| Type | ${((u=this.institution.types)==null?void 0:u.join(", "))||"N/A"} |
| Aliases | ${[...this.institution.aliases||[],this.institution.name,...this.institution.acronyms?[this.institution.acronyms[0]]:[]].join(", ")||"N/A"} | 
| Location | ${"["+((d=(p=this.institution.addresses)==null?void 0:p[0])==null?void 0:d.lat)+", "+((y=(f=this.institution.addresses)==null?void 0:f[0])==null?void 0:y.lng)+"]"} |
| Wikipedia | ${this.institution.wikipedia_url||"N/A"} |
| Logo | ${((g=(h=this.institution.logos)==null?void 0:h[0])==null?void 0:g.url)||"N/A"} |`;await a.MarkdownRenderer.render(this.app,e,this.resultContainer,"",this.plugin),this.confirmButton.settingEl.show(),this.confirmButton.setDisabled(this.plugin.checkIfInstitutionNoteExists(this.institutionName)),this.confirmButton.setTooltip(this.plugin.checkIfInstitutionNoteExists(this.institutionName)?"Institution Note Already Exists":"Create Institution Note")}onClose(){this.contentEl.empty()}}function K(s,e){const t=Object.keys(e).map(r=>$(s,r,e[r]));return t.length===1?t[0]:function(){t.forEach(r=>r())}}function $(s,e,t){const r=s[e],i=s.hasOwnProperty(e),n=i?r:function(){return Object.getPrototypeOf(s)[e].apply(this,arguments)};let o=t(n);return r&&Object.setPrototypeOf(o,r),Object.setPrototypeOf(c,o),s[e]=c,l;function c(...u){return o===n&&s[e]===c&&l(),o.apply(this,u)}function l(){s[e]===c&&(i?s[e]=n:delete s[e]),o!==n&&(o=n,Object.setPrototypeOf(c,r||Function))}}class J{constructor(e){this.vault=e}processTemplate(e,t){let r=e;for(const[i,n]of Object.entries(t.institute)){const o=new RegExp(`{{\\s*ppb\\.institute\\.${i}\\s*}}`,"g");Array.isArray(n)?r=r.replace(o,n.map(c=>`- ${c}`).join(`
`)):r=r.replace(o,String(n))}return r}async readTemplateFile(e){try{const t=this.vault.getFileByPath(e+".md");return t instanceof a.TFile?await this.vault.read(t):null}catch(t){return console.error("Error reading template file:",t),null}}getVariablesFromInstitution(e){return{institute:{abbr:e.abbr,aliases:e.aliases,website:e.website,lon:e.location[1],lat:e.location[0],logo:e.logo,name:e.name,tags:e.tags}}}}class L extends a.Plugin{constructor(){super(...arguments),this.settings=S}async onload(){await this.loadSettings(),this.templateProcessor=new J(this.app.vault),this.verificationWorker=new D(this.app,this.settings.registrationId),this.addSettingTab(new R(this.app,this));const e={searchInstitution:this.searchInstitution.bind(this),createInstitutionNote:this.createInstitutionNote.bind(this)};window.paperbell=e,this.app.workspace.onLayoutReady(()=>{this.registerEvent(this.app.vault.on("create",async t=>{var i;const r=await this.verificationWorker.verify();if(typeof r!="boolean"){new a.Notice("Please input the verification code first in settings.");return}if(!r){new a.Notice("Please verify your account first.");return}((i=t.parent)==null?void 0:i.path)===this.settings.listenToFileCreatedInPath&&t instanceof a.TFile&&typeof r=="boolean"&&r&&await this.handleNewFile(t)}))}),this.addCommand({id:"search-institution",name:"Search Institution",callback:()=>{new v(this.app,this,"").open()}}),this.addRibbonIcon("graduation-cap","Search Institution",()=>{new v(this.app,this,"").open()}),this.patchSettingTab()}async handleNewFile(e){const t=await this.app.vault.read(e),r=a.getFrontMatterInfo(t);if(!r.exists)return;const i=a.parseYaml(r.frontmatter);!i.institute&&!i.institution||await this.processInstitution(i.institute||i.institution)}checkIfInstitutionNoteExists(e){var r;const t=this.app.vault.getMarkdownFiles();for(const i of t){const n=this.app.metadataCache.getFileCache(i);if(((r=n==null?void 0:n.frontmatter)==null?void 0:r.name)===e)return!0}return!1}async processInstitution(e){const t=await this.searchInstitution(e);if(!this.checkIfInstitutionNoteExists(e)){if(!this.settings.autoGenerateInstitutionNotes){new v(this.app,this,e).open();return}t&&await this.createInstitutionNote(t)}}async searchInstitution(e){var n,o,c,l,u,p,d,f,y;const t=await this.verificationWorker.verify();if(typeof t!="boolean")return new a.Notice("Please input the verification code first in settings."),null;if(!t)return new a.Notice("Please verify your account first."),null;const i=await(await a.requestUrl({url:`https://api.ror.org/v1/organizations?query=${encodeURIComponent(`"${e}"`)}`,method:"GET"})).json;if(i.items&&i.items.length>0){const h=i.items[0];return{abbr:((n=h.acronyms)==null?void 0:n[0])||"",aliases:[...h.aliases||[],...((o=h.labels)==null?void 0:o.map(g=>g.label))||[]],website:((c=h.links)==null?void 0:c[0])||"",location:[((u=(l=h.addresses)==null?void 0:l[0])==null?void 0:u.lat)||0,((d=(p=h.addresses)==null?void 0:p[0])==null?void 0:d.lng)||0],logo:"",name:((y=(f=h.labels)==null?void 0:f[0])==null?void 0:y.label)||h.name,tags:["university"]}}return null}async createInstitutionNote(e){var u;const t=await this.verificationWorker.verify();if(typeof t!="boolean"){new a.Notice("Please input the verification code first in settings.");return}if(!t){new a.Notice("Please verify your account first.");return}const r=this.app.vault.getMarkdownFiles();for(const p of r){const d=await this.app.metadataCache.getFileCache(p);if(((u=d==null?void 0:d.frontmatter)==null?void 0:u.name)===e.name)return}const i=await this.createInstitutionNoteContent(e),n=e.name.replace(/[\\/:*?"<>|]/g,""),o=this.settings.noteLocation;this.app.vault.getFolderByPath(o)||await this.app.vault.createFolder(o);const l=await this.app.vault.create(`${o}/${n}.md`,i);this.settings.openInstitutionAfterCreation&&this.app.workspace.getLeaf().openFile(l)}async createInstitutionNoteContent(e){const t=this.templateProcessor.getVariablesFromInstitution(e);if(this.settings.institutionNoteTemplate){const r=await this.templateProcessor.readTemplateFile(this.settings.institutionNoteTemplate);if(r)return this.templateProcessor.processTemplate(r,t)}return`---
abbr: ${e.abbr}
aliases:
${e.aliases.map(r=>`- ${r}`).join(`
`)}
website: ${e.website}
lon: ${e.location[1]}
lat: ${e.location[0]}
logo: "${e.logo}"
name: ${e.name}
tags:
- university
---

## 相关学者

\`\`\`dataviewjs
let name = dv.current().name

dv.table(["姓名","职称","主页","邮箱"],
dv.pages(\`#scholar\`)
  .where(b => b.institute.includes(name))
  .map(b => [b.file.link, b.title, ("[🔗]("+b.website+")"), b.email])
  .sort(b => b.paper_date, 'desc')
)
\`\`\``}patchSettingTab(){const e=this.app.setting,t=Object.getPrototypeOf(e),r=K(t,{onOpen:i=>function(){const n=this.pluginTabs.find(c=>c.id==="paperbell");return n&&(n.navEl.dataset.pluginId="paperbell",n.navEl.style.order="-1",n.navEl.createEl("span",{cls:"vertical-tab-nav-item-pro"})),i.call(this)}});this.register(r)}onunload(){}async loadSettings(){this.settings=Object.assign({},S,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}}module.exports=L;
